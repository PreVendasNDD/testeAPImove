log "Chamando NDD..."

TOKEN_RESP=$(curl -s -k -X POST https://icomprova.nddcargo.com.br:9051/connect/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "client_id=$CLIENT_ID" \
  -d "client_secret=$CLIENT_SECRET" \
  -d "grant_type=client_credentials" \
  -d "scope=i-comprova-entregas-integration-api" || echo "CURL_ERROR")

log "Resposta NDD bruta:"
log "$TOKEN_RESP"

TOKEN=$(echo "$TOKEN_RESP" | jq -r '.access_token // empty')

if [ -z "$TOKEN" ]; then
  log "NDD nÃ£o retornou token"
else
  log "Token recebido"
  jq --arg t "$TOKEN" '.token={masked:($t|.[:6]+"****"+.[-6:])}' responses/result.json > tmp.json && mv tmp.json responses/result.json
fi
