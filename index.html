<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste Endpoints iComprova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0e0e0e;
      color: #ffffff;
      padding: 30px;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #1e88e5;
      color: #fff;
      border: none;
      border-radius: 4px;
      margin: 10px 5px;
    }
    pre {
      margin-top: 20px;
      background: #1c1c1c;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .error { color: #ff5252; }
    .success { color: #4caf50; }
  </style>
</head>
<body>

  <h2>Teste de Endpoints iComprova</h2>
  <button onclick="testarEndpoints()">Testar Todos os Endpoints</button>
  <pre id="resultado">Clique para testar endpoints...</pre>

  <script>
    let accessToken = '';

    async function obterToken() {
      const body = new URLSearchParams({
        client_id: "4a3a17846e714b3288682c5260455347",
        client_secret: "FFVkTyaM4zVsLYAhKpGIT57C72EzYPSOqFO+O/P9y0Y=",
        scope: "i-comprova-entregas-integration-api",
        grant_type: "client_credentials"
      });

      const response = await fetch("https://icomprova.nddcargo.com.br:9051/connect/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      });

      const data = await response.json();
      if (response.ok) {
        accessToken = data.access_token;
        return true;
      }
      return false;
    }

    async function testarEndpoint(url, method = 'GET') {
      try {
        const response = await fetch(url, {
          method: method,
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          }
        });
        return { url, status: response.status, ok: response.ok };
      } catch (err) {
        return { url, status: 'ERRO', ok: false, error: err.message };
      }
    }

    async function testarEndpoints() {
      const resultado = document.getElementById("resultado");
      resultado.textContent = "Testando endpoints...\n\n";
      
      // Primeiro pega token
      resultado.textContent += "1. Obtendo token...\n";
      const tokenOk = await obterToken();
      
      if (!tokenOk) {
        resultado.textContent += "❌ Erro ao obter token\n";
        return;
      }
      
      resultado.textContent += "✅ Token obtido\n\n";
      resultado.textContent += "2. Testando endpoints...\n\n";
      
      // Testa diferentes padrões de URL
      const endpoints = [
        // Padrão 1: /api/Recepcoes/MDFe
        "https://icomprova.nddcargo.com.br:9051/api/Recepcoes/MDFe",
        "https://icomprova.nddcargo.com.br:9051/api/recepcoes/mdfe",
        "https://icomprova.nddcargo.com.br:9051/api/MDFe",
        "https://icomprova.nddcargo.com.br:9051/api/mdfe",
        
        // Padrão 2: /api/v1/...
        "https://icomprova.nddcargo.com.br:9051/api/v1/Recepcoes/MDFe",
        "https://icomprova.nddcargo.com.br:9051/api/v1/recepcoes/mdfe",
        
        // Padrão 3: /api/integracao/...
        "https://icomprova.nddcargo.com.br:9051/api/integracao/mdfe",
        "https://icomprova.nddcargo.com.br:9051/api/integracao/cte",
        
        // Padrão 4: Direto na raiz
        "https://icomprova.nddcargo.com.br:9051/Recepcoes/MDFe",
        "https://icomprova.nddcargo.com.br:9051/recepcoes/mdfe",
        
        // Padrão 5: Com diferente porta
        "https://icomprova.nddcargo.com.br/api/Recepcoes/MDFe",
        "https://icomprova.nddcargo.com.br/api/recepcoes/mdfe",
      ];
      
      for (let i = 0; i < endpoints.length; i++) {
        const endpoint = endpoints[i];
        resultado.textContent += `Testando: ${endpoint}\n`;
        
        const result = await testarEndpoint(endpoint, 'GET');
        
        if (result.ok) {
          resultado.textContent += `✅ Status ${result.status} - ENDPOINT ENCONTRADO!\n\n`;
          // Se encontrou um que funciona, testa os outros métodos
          resultado.textContent += `Agora testando POST em: ${endpoint}\n`;
          
          try {
            const postResponse = await fetch(endpoint, {
              method: 'POST',
              headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ documento: "test" })
            });
            resultado.textContent += `POST: Status ${postResponse.status}\n`;
          } catch (e) {
            resultado.textContent += `POST Erro: ${e.message}\n`;
          }
          
          resultado.textContent += "\n";
          break;
        } else {
          resultado.textContent += `❌ Status ${result.status}\n`;
        }
        
        // Pequena pausa entre requisições
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      resultado.textContent += "\n✅ Teste completo!";
    }
  </script>

</body>
</html>
