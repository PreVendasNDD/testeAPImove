<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Descobrir Endpoint iComprova</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #111; color: white; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        pre { background: #222; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; }
        .found { background: #155724; color: #d4edda; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>
    <h2>Descobrir Endpoint da API</h2>
    <button onclick="discover()">üîç Iniciar Teste</button>
    <pre id="result">Clique no bot√£o para iniciar a descoberta.</pre>

    <script>
        let currentToken = '';

        async function getAuthToken() {
            // Usando EXATAMENTE suas credenciais e fluxo
            const body = new URLSearchParams({
                client_id: "4a3a17846e714b3288682c5260455347",
                client_secret: "FFVkTyaM4zVsLYAhKpGIT57C72EzYPSOqFO+O/P9y0Y=",
                scope: "i-comprova-entregas-integration-api",
                grant_type: "client_credentials"
            });

            const response = await fetch("https://icomprova.nddcargo.com.br:9051/connect/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: body.toString()
            });

            const data = await response.json();
            if (response.ok) {
                currentToken = data.access_token;
                return true;
            }
            return false;
        }

        async function testEndpoint(baseUrl, path) {
            const fullUrl = `${baseUrl}${path}`;
            try {
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                // O que importa √© se a URL existe (status 2xx, 4xx, 5xx) ou n√£o (erro de rede/CORS)
                return {
                    url: fullUrl,
                    status: response.status,
                    exists: response.status !== 404 // Considera que existe se n√£o for 404
                };
            } catch (error) {
                // Erro de rede, CORS, etc. A URL n√£o √© acess√≠vel.
                return {
                    url: fullUrl,
                    status: 'NETWORK_ERROR',
                    exists: false
                };
            }
        }

        async function discover() {
            const resultElement = document.getElementById('result');
            resultElement.innerHTML = "Obtendo token de autentica√ß√£o...\n";

            // 1. Pega o token
            const tokenOk = await getAuthToken();
            if (!tokenOk) {
                resultElement.innerHTML += "‚ùå Falha ao obter token. Verifique as credenciais.\n";
                return;
            }
            resultElement.innerHTML += "‚úÖ Token obtido com sucesso.\n\n";
            resultElement.innerHTML += "Iniciando teste de endpoints...\n\n";

            const baseDomain = 'https://icomprova.nddcargo.com.br:9051';
            
            // Lista de PREFIXOS comuns que podem estar antes do endpoint
            // A ideia √© descobrir qual √© a "raiz" da API (api/, api/v1/, /integracao/, etc.)
            const prefixPathsToTest = [
                '', // Testa a raiz pura
                '/api',
                '/api/v1',
                '/api/v2',
                '/v1',
                '/v2',
                '/integracao',
                '/api/integracao',
                '/rest',
                '/service'
            ];

            let foundBase = null;

            // Testa cada prefixo
            for (const prefix of prefixPathsToTest) {
                const testUrl = `${baseDomain}${prefix}`;
                resultElement.innerHTML += `Testando: <code>${testUrl}</code> ... `;

                const testResult = await testEndpoint(baseDomain, prefix);

                if (testResult.exists && testResult.status !== 404) {
                    // Se n√£o deu 404, encontramos uma raiz potencial!
                    foundBase = prefix;
                    resultElement.innerHTML += `<span class="found">‚úÖ ENCONTRADO! (Status: ${testResult.status})</span>\n`;
                    break; // Para no primeiro que achar
                } else {
                    resultElement.innerHTML += `‚ùå (Status: ${testResult.status})\n`;
                }
                // Pequena pausa para n√£o sobrecarregar
                await new Promise(r => setTimeout(r, 300));
            }

            resultElement.innerHTML += "\n---\n";

            if (foundBase !== null) {
                // Se achou uma raiz, testa o endpoint completo de MDFe nela
                resultElement.innerHTML += `<strong>Base encontrada:</strong> <code>${foundBase}</code>\n`;
                const finalMdfePath = `${foundBase}/Recepcoes/MDFe`;
                const finalCtePath = `${foundBase}/Recepcoes/CTe`;

                resultElement.innerHTML += `\nTestando endpoint MDF-e: <code>${finalMdfePath}</code> ... `;
                const mdfeTest = await testEndpoint(baseDomain, finalMdfePath);
                resultElement.innerHTML += `Status: ${mdfeTest.status}\n`;

                resultElement.innerHTML += `Testando endpoint CT-e: <code>${finalCtePath}</code> ... `;
                const cteTest = await testEndpoint(baseDomain, finalCtePath);
                resultElement.innerHTML += `Status: ${cteTest.status}\n`;

                // Conclus√£o
                resultElement.innerHTML += `\nüéØ <strong>URL FINAL SUGERIDA PARA TESTE:</strong>\n`;
                resultElement.innerHTML += `<code>${baseDomain}${finalMdfePath}</code>\n`;
            } else {
                resultElement.innerHTML += "‚ùå Nenhuma raiz de API comum foi encontrada no dom√≠nio fornecido.\n";
                resultElement.innerHTML += "\nIsso indica que:\n";
                resultElement.innerHTML += "1. O dom√≠nio base pode estar incorreto; OU\n";
                resultElement.innerHTML += "2. A API exige um caminho espec√≠fico n√£o testado; OU\n";
                resultElement.innerHTML += "3. A API n√£o est√° acess√≠vel via navegador (CORS).\n";
                resultElement.innerHTML += "\n<strong>Pr√≥ximo passo obrigat√≥rio:</strong> Contatar o suporte do iComprova/NDD Cargo e solicitar a <em>URL de integra√ß√£o completa</em> para a API de recep√ß√£o de documentos (n√£o apenas para o token).";
            }
        }
    </script>
</body>
</html>
